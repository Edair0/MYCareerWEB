@using IndexedDB.Blazor
@using MYCareerWEB.Code;
@using MYCareerWEB.Code.PlayerData
@inject IIndexedDbFactory DbFactory

<div class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 row-cols-xxl-5 g-1">
    @for (int i = 0; i < Names.Length; i++)
    {
        int id = i;
        int cost = CalculateCost(Data.Level[id], Modifiers[i, 0], Modifiers[i, 1], Modifiers[i, 2]);
        <div class="col">
            <div class="card h-100 text-center">
                <div class="card-header h-100 d-flex align-items-center justify-content-center border-0">
                    @Names[i]
                </div>
                <div class="card-body align-self-center">
                    <label class="pe-1">@Data.Level[id]</label>
                    <button class="btn-primary" @onclick="() => UpgradeAttribute(id, cost)"><i class="fa fa-plus"></i> @(cost)XP</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public AttributeType Type { get; set; }
    [Parameter]
    public string[] Names { get; set; }
    [Parameter]
    public AttributeData Data { get; set; }
    [Parameter]
    public float[,] Modifiers { get; set; }

    //protected override void OnInitialized()
    //{
    //    AppData.RefreshService.RefreshRequested += RefreshMe;
    //    base.OnInitialized();
    //}

    //private void RefreshMe()
    //{
    //    StateHasChanged();
    //}

    private async Task UpgradeAttribute(int id, int cost)
    {
        
        int currentLevel = Data.Level[id];

        if (Data.XP >= cost && cost != 0)
        {
            Data.Level[id] += 1;
            Data.XP -= cost;
        }

        using (var db = await this.DbFactory.Create<AppDB>())
        {
            Player EditedPlayer = db.Players.Single(x => x.Id == AppData.CurrentPlayer.Id);
            EditedPlayer.Attributes = AppData.CurrentPlayer.Attributes;
            await db.SaveChanges();
        }
        AppData.RefreshService.CallRequestRefresh();
    }

    private int CalculateCost(int CurrentStat, float DifficultyMod, float HeightMod, float WeightMod)
    {
        int BaseCost = 10;
        float ScallingFactor = 1.06f;
        return (int)Math.Ceiling(((BaseCost * Math.Pow(ScallingFactor, CurrentStat)) / 2) * DifficultyMod * HeightMod * WeightMod);
    }
}
